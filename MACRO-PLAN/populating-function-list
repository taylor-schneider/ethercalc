## Underlying Technology

EtherCalc
- Repository: https://github.com/audreyt/ethercalc
- Nature: Node.js collaborative spreadsheet server application
- Purpose: Provides multi-user editing, persistence, web interface, and room-based isolation
- Dependencies: Includes SocialCalc as an npm package ("socialcalc": "^2.3.0")

SocialCalc
- Official Repository: https://github.com/DanBricklin/socialcalc
- Popular Fork (used by EtherCalc): https://github.com/marcelklehr/socialcalc
- Nature: Standalone JavaScript spreadsheet engine library
- Purpose: Core spreadsheet functionality (formula evaluation, cell management, parsing)
- Distribution: Published as npm package that EtherCalc loads via its bootSC mechanism

## Ethercalc's current bootSC mechanism

The bootSC object is a dynamically constructed JavaScript string that contains the entire SocialCalc library plus Node.js compatibility modifications. This string is ultimately evaluated by the VM created for the room (worksheet). The SocialCalc code contained in the string is what populates the FunctionList object used by SocialCalc to resolve function names etc.

1. **Load raw source code**
bootSC starts as the raw SocialCalc.js file content. The source code is literally read from the file included in the npm package.

    ```
    // Read the entire SocialCalc library as a string
    bootSC = fs.readFileSync(FindBin + "/node_modules/socialcalc/SocialCalc.js", 'utf8');
    ```

2. **Modify source for browser compatibility**
Ethercalc's codebase then modifies the SocialCalc code base to make it compatible with a browser 

    ```
    bootSC.=replace(/document\.createElement\(/g, 'SocialCalc.document.createElement(')
    bootSC.=replace(/alert\(/g, '(function(){})(')
    ```
    and node.js.
    ```
    bootSC += """;var navigator = {language: '', userAgent: ''}; var SocialCalc = this.SocialCalc; var window = this;(#{->
    // ... DOM shim code for Node.js environment
    })();"""
    ```
3. **Create VM Context**
Each EtherCalc room gets its own worker which in tern sets up an isolated JavaScript context using Node.js vm.createContext():

4. **Evaluate the bootSC string**
The bootSC string is then evaluated within the isolated VM context for the room.
    ```
    w.thread.eval bootSC, ~> w.postMessage { type: \init, room, log, snapshot }
    ```

5. **Set the function list**
The SocialCalc codebase being evaluated sets up the function list.

    ```
    // From within SocialCalc.js (executed during bootSC evaluation):
    SocialCalc.Formula.FunctionList = SocialCalc.Formula.FunctionList || {};

    // Built-in functions get registered:
    SocialCalc.Formula.FunctionList.SUM = [SocialCalc.Formula.SeriesFunctions, -1, "vn", null, "stat"];
    SocialCalc.Formula.FunctionList.AVERAGE = [SocialCalc.Formula.SeriesFunctions, -1, "vn", null, "stat"];
    SocialCalc.Formula.FunctionList.COUNT = [SocialCalc.Formula.SeriesFunctions, -1, "vn", null, "stat"];
    // ... 100+ more built-in functions
    ```

## Proposed changes

We want the function list to change to a function map which mirrors the structure of the macros map. All of the builtin functions should be registered to the _biltin repo while the other functions are registered to their respective repo as they are written / discovered.

We will need to add a shim that runs after the initial function list is created to transform it into the new map structure.

```
room.functionList = Map {
  '_builtin_': Map {
    'MYFUNC': myUdfFunc,
    'CALCTAX': calcTaxFunc
    //... Remaining 100+ built in fucntions from social calc
  },
  'default': Map {
    // ... UDFs stored directly in the snapshot
  },
  'myrepo': Map {
    'SPECIALFUNC': specialFunc
    // ... UDFs stored in the remote repo
  }
}
```
### Additional Shims

##### Required Updates to SocialCalc
To support the hierarchical functionList structure (replacing the flat `SocialCalc.Formula.FunctionList` object with a Map of Maps for repo-organized UDFs), the following exact functions in SocialCalc need to be modified. These are based on the current usage patterns in the codebase (derived from the minified `static/ethercalc.js` and SocialCalc's formula evaluation logic):

1. **`SocialCalc.Formula.CalculateFunction`**  
   - **Current behavior**: Directly accesses `u.FunctionList[e]` where `e` is the function name (e.g., "SUM").  
   - **Required change**: Replace the direct lookup with a hierarchical lookup function that:  
     - Splits `e` on "." (e.g., "myrepo.SUM" â†’ ["myrepo", "SUM"]).  
     - If qualified (has "."), looks up in `u.FunctionList.get(repo).get(func)`.  
     - If unqualified, searches fallback repos (e.g., "default", "_builtin") in order.  
     - Returns the function definition array or `null` if not found.  
   - **Why**: This is the core function evaluation entry point; all formula calculations go through here.

2. **`SocialCalc.Formula.FillFunctionInfo`**  
   - **Current behavior**: Iterates `for(e in a.FunctionList)` to build `FunctionClasses` and `FunctionArgDefs`.  
   - **Required change**: Update to iterate over all repos in the hierarchical Map (e.g., `for (let [repoName, repoMap] of a.FunctionList)` then `for (let [funcName, funcDef] of repoMap)`), collecting functions from all repos while preserving class categorization.  
   - **Why**: Ensures function info/metadata (args, descriptions, classes) is populated from UDF repos, not just built-ins.

3. **`SocialCalc.Formula.FunctionArgString`**  
   - **Current behavior**: Directly accesses `a.FunctionList[e]` to get function args.  
   - **Required change**: Use the same hierarchical lookup function as `CalculateFunction` to retrieve the function definition, then extract args from it.  
   - **Why**: Used for displaying function signatures in the UI (e.g., tooltips during formula input).

4. **`SocialCalc.Formula.SetInputEchoText`**  
   - **Current behavior**: Checks `t.Formula.FunctionList[i]` for existence to show function prompts.  
   - **Required change**: Replace with a call to the hierarchical lookup function to check if the function exists (qualified or unqualified).  
   - **Why**: Provides autocomplete/intellisense for UDFs in the formula input echo.

5. **Unnamed input widget rendering function** (appears in the minified code around line 5 of `static/ethercalc.js`)  
   - **Current behavior**: Accesses `t.Formula.FunctionList[d]` for widget parameter handling.  
   - **Required change**: Use the hierarchical lookup function instead of direct access.  
   - **Why**: Ensures UDFs work in input widgets/forms.


